##Moving averages

The classical method of time series decomposition originated in the 1920s and was widely used until the 1950s. It still forms the basis of many time series decomposition methods, and so it is important to understand how it works. The first step in a classical decomposition is to use a moving average method to estimate the trend-cycle, so we begin by discussing moving averages.

### Moving average smoothing {-}

A moving average of order $m$ can be written as
$$
  \hat{T}_{t} = \frac{1}{m} \sum_{j=-k}^k y_{t+j},
$$ 
where $m=2k+1$. That is, the estimate of the trend-cycle at time $t$ is obtained by averaging values of the time series within $k$ periods of $t$. Observations that are nearby in time are also likely to be close in value, and the average eliminates some of the randomness in the data, leaving a smooth trend-cycle component. We call this an “$m$-MA” meaning a moving average of order $m$.

```{r ressales1, fig.cap="Residential electricity sales (excluding hot water) for South Australia: 1989--2008."}
autoplot(elecsales) + xlab("Year") + ylab("GWh") +
  ggtitle("Annual electricity sales: South Australia")
```

For example, consider Figure \@ref(fig:ressales1) showing the volume of electricity sold to residential customers in South Australia each year from 1989 to 2008 (hot water sales have been excluded). The data are also shown in Table \@ref(tab:elecsales).

```{r}
ma5 <- ma(elecsales, 5)
```
```{r elecsales, echo=FALSE}
tab <- cbind(Year=time(elecsales), 
             "Sales (GWh)"=elecsales, 
             "5-MA"=ma5)
out <- knitr::kable(tab, booktabs=TRUE,
    caption = "Annual electricity sales to residential customers in South Australia. 1989--2008.",     
    format.args=list(digits=6, trim=FALSE))
out <- gsub('NA','  ', out)
out
```

In the second column of this table, a moving average of order 5 is shown, providing an estimate of the trend-cycle. The first value in this column is the average of the first five observations (1989--1993); the second value in the 5-MA column is the average of the values 1990--1994; and so on. Each value in the 5-MA column is the average of the observations in the five year period centered on the corresponding year. There are no values for the first two years or last two years because we don’t have two observations on either side. In the formula above, column
5-MA contains the values of $\hat{T}_{t}$ with $k=2$. To see what the trend-cycle estimate looks like, we plot it along with the original data in Figure \@ref(fig:ressales2).

```{r ressales2, fig.cap="Residential electricity sales (black) along with the 5-MA estimate of the trend-cycle (red)."}
tmp <- cbind(Data=elecsales, '5-MA'=ma(elecsales,5))
autoplot(tmp) + xlab("Year") + ylab("GWh") +
  ggtitle("Annual electricity sales: South Australia") +
  scale_color_manual(values=c('red','grey50'),
                     breaks=c("5-MA","Data"))

```
Notice how the trend (in red) is smoother than the original data and captures the main movement of the time series without all the minor fluctuations. The moving average method does not allow estimates of $T_{t}$ where $t$ is close to the ends of the series; hence the red line does not extend to the edges of the graph on either side. Later we will use more sophisticated methods of trend-cycle estimation which do allow estimates near the endpoints.

The order of the moving average determines the smoothness of the trend-cycle estimate. In general, a larger order means a smoother curve. Figure \@ref(fig:ressales3) shows the effect of changing the order of the moving average for the residential electricity sales data.

```{r ressales3, fig.cap="Different moving averages applied to the residential electricity sales data."}
grobs <- list()
mak <- c(3,5,7,9)
for(m in seq(mak))
{
  tmp <- cbind(Data=elecsales, MA=ma(elecsales,mak[m]))
  autoplot(tmp) + 
    scale_color_manual(values=c("grey50","red")) +
    ggtitle(paste(mak[m],"-MA", sep="")) +
    xlab("Year") + ylab("GWh") +
    theme(legend.position='none') -> grobs[[m]]
}
gridExtra::grid.arrange(grobs=grobs,ncol=2)
```

Simple moving averages such as these are usually of odd order (e.g., 3, 5, 7, etc.) This is so they are symmetric: in a moving average of order $m=2k+1$, there are $k$ earlier observations, $k$ later observations and the middle observation that are averaged. But if $m$ was even, it would no longer be symmetric.

### Moving averages of moving averages {-}

It is possible to apply a moving average to a moving average. One reason for doing this is to make an even-order moving average symmetric.

For example, we might take a moving average of order 4, and then apply another moving average of order 2 to the results. In the following table, this has been done for the first few years of the Australian quarterly beer production data.

```{r}
beer2 <- window(ausbeer,start=1992) 
ma4 <- ma(beer2, order=4, centre=FALSE) 
ma2x4 <- ma(beer2, order=4, centre=TRUE)
```

```{r echo=FALSE}
tab <- data.frame(Year=trunc(time(beer2)),
             Quarter=paste("Q",cycle(beer2),sep=''),
             Data=beer2,
             '4-MA'=ma4, 
             '2x4-MA'=ma2x4)
colnames(tab)[4:5] <- c("4-MA","2x4-MA")
out <- knitr::kable(tab[1:20,])
out <- gsub('NA','  ', out)
out
```

The notation “$2\times4$-MA” in the last column means a 4-MA followed by a 2-MA. The values in the last column are obtained by taking a moving average of order 2 of the values in the previous column. For example, the first two values in the 4-MA column are 
`r ma4[2]`=(`r beer2[1]`+`r beer2[2]`+`r beer2[3]`+`r beer2[4]`)/4 
and 
`r ma4[3]`=(`r beer2[2]`+`r beer2[3]`+`r beer2[4]`+`r beer2[5]`)/4.

451.2=(443+410+420+532)/4
and 448.8=(410+420+532+433)/4. 

The first value in the 2x4-MA column is the average of these two: 
`r ma2x4[3]`=(`r ma4[2]`+`r ma4[3]`)/2.

450.0=(451.2+448.8)/2.

When a 2-MA follows a moving average of even order (such as 4), it is called a “centered moving average of order 4”. This is because theresults are now symmetric. To see that this is the case, we can writevthe $2\times4$-MA as follows:
\begin{align}
  \hat{T}_{t} &= \frac{1}{2}\Big[
    \frac{1}{4} (y_{t-2}+y_{t-1}+y_{t}+y_{t+1}) +
    \frac{1}{4} (y_{t-1}+y_{t}+y_{t+1}+y_{t+2})\Big] \\
             &= \frac{1}{8}y_{t-2}+\frac14y_{t-1} +
             \frac14y_{t}+\frac14y_{t+1}+\frac18y_{t+2}.
\end{align} 
It is now a weighted average of observations, but it is symmetric.

Other combinations of moving averages are also possible. For example a $3\times3$-MA is often used, and consists of a moving average of order 3 followed by another moving average of order 3. In general, an even order MA should be followed by an even order MA to make it symmetric. Similarly, an odd order MA should be followed by an odd order MA.

### Estimating the trend-cycle with seasonal data {-}

The most common use of centered moving averages is in estimating the trend-cycle from seasonal data. Consider the $2\times4$-MA:
$$
  \hat{T}_{t} = \frac{1}{8}y_{t-2} + \frac14y_{t-1} +
    \frac14y_{t} + \frac14y_{t+1} + \frac18y_{t+2}.
$$
When applied to quarterly data, each quarter of the year is given equal weight as the first and last terms apply to the same quarter in consecutive years. Consequently, the seasonal variation will be averaged out and the resulting values of $\hat{T}_t$ will have little or no seasonal variation remaining. A similar effect would be obtained using a $2\times 8$-MA or a $2\times 12$-MA.

In general, a $2\times m$-MA is equivalent to a weighted moving average of order $m+1$ with all observations taking weight $1/m$ except for the first and last terms which take weights $1/(2m)$. So if the seasonal period is even and of order $m$, use a $2\times m$-MA to estimate the trend-cycle. If the seasonal period is odd and of order $m$, use a $m$-MA to estimate the trend cycle. In particular, a $2\times 12$-MA can be used to estimate the trend-cycle of monthly data and a 7-MA can be used to estimate the trend-cycle of daily data.

Other choices for the order of the MA will usually result in trend-cycle estimates being contaminated by the seasonality in the data.

###Example: Electrical equipment manufacturing {-}

```{r elecequip2, fig.cap="A 2x12-MA applied to the electrical equipment orders index."}
tmp <- cbind(Data=elecequip, '12MA'=ma(elecequip,12))
autoplot(tmp) + xlab("Year") +
  ylab("New orders index") +
  ggtitle("Electrical equipment manufacturing (Euro area)") + 
  scale_color_manual(values=c("red","grey"), breaks=c("Data","12MA"))
```

Figure \@ref(fig:elecequip2) shows a $2\times12$-MA applied to the electrical equipment orders index. Notice that the smooth line shows no seasonality; it is almost the same as the trend-cycle shown in Figure \@ref(fig:elecequip-trend) which was estimated using a much more sophisticated method than moving averages. Any other choice for the order of the moving average (except for 24, 36, etc.) would have resulted in a smooth line that shows some seasonal fluctuations.


### Weighted moving averages {-}

Combinations of moving averages result in weighted moving averages. For example, the $2\times4$-MA discussed above is equivalent to a weighted 5-MA with weights given by
$\left[\frac{1}{8},\frac{1}{4},\frac{1}{4},\frac{1}{4},\frac{1}{8}\right]$. In general, a weighted $m$-MA can be written as 
$$
  \hat{T}_t = \sum_{j=-k}^k a_j y_{t+j},
$$ 
where $k=(m-1)/2$ and the weights are given by $\left[a_{-k},\dots,a_k\right]$. It is important that the weights all sum to one and that they are symmetric so that $a_j = a_{-j}$. The simple $m$-MA is a special case where all the weights are equal to $1/m$.

A major advantage of weighted moving averages is that they yield a smoother estimate of the trend-cycle. Instead of observations entering and leaving the calculation at full weight, their weights are slowly increased and then slowly decreased resulting in a smoother curve.

Some specific sets of weights are widely used. Some of these are given in Table \@ref(tab:weights).

```{r weights, echo=FALSE}
weights <- matrix(NA,ncol=12,nrow=11)
colnames(weights) <- paste("$a_{",0:11,"}$",sep="")
rownames(weights) <- c("3-MA","5-MA","2x12-MA",
                       "3x3-MA","3x5-MA",
                       "S15-MA","S21-MA",
                       "H5-MA","H9-MA","H13-MA","H23-MA")
weights[1,1:2] <- 1/3
weights[2,1:3] <- 1/5
weights[3,1:6] <- 1/12
weights[3,7] <- 1/24
weights[4,1:3] <- (3:1)/9
weights[5,1:4] <- c(3,3,2,1)/15
weights[6,1:8] <- c(74,67,46,21,3,-5,-6,-3)/320
weights[7,1:11] <- c(60,57,47,33,18,6,-2,-5,-5,-3,-1)/350
weights[8,1:3] <- c(.558,.294,-.073)
weights[9,1:5] <- c(.330,.267,.119,-.010,-.041)
weights[10,1:7] <- c(.240,.214,.147,.066,.000,-.028,-.019)
weights[11,1:12] <- c(.148,.138,.122,.097,.068,.039,.013,-.005,-.015,-.016,-.011,-.004)

# Test
tmp <- 2*rowSums(weights, na.rm=TRUE)-weights[,1]
if(max(abs(tmp-1)) > 0.02)
  stop("Weights incorrect")

# Show table
out <- knitr::kable(weights,digits=3,booktabs=TRUE,
    caption = "Commonly used weights in weighted moving averages. S=Spencer's weighted moving average. H=Henderson's weighted moving average",
    format.args=list(digits=3, trim=FALSE))
out <- gsub('NA','  ', out)
out
```



